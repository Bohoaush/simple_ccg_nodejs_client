 <!DOCTYPE html>
 <html>
 <head>
    <meta charset="utf-8">
    <title>Playlist editor | nodecg CCG client</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body
        {
            font-family: Ubuntu;
            color: white;
            background-color: #171717;
        }
        .plyitem
        {
            color: white;
            background-color: #222222;
            padding-top: 10px;
            padding-bottom: 10px;
        }
        .odd
        {
            background-color: #333333;
        }
    </style>
 </head>
 <body>
    <input name="play_btn" id="play_btn" value="play" type="submit" />
    <input name="stop_btn" id="stop_btn" value="stop" type="submit" />
    <input name="ldply_btn" id="ldply_btn" value="Load playlist" type="submit" />
    <input name="mvItemUp" id="mvItemUp" value="up" type="submit" />
    <input name="mvItemDown" id="mvItemDown" value="down" type="submit" />
    <input name="syncPly" id="syncPly" value="Upload playlist" type="submit" />
    <input name="drawDebugInfo" id="drawDebugInfo" value="Draw debug info" type="submit" />
    <input name="tgglEdit" id="tgglEdit" value="Toggle edit" type="submit" />
    <div id="inspectorWrapper">
        <!--<div>Edit item:</div>-->
        <div id="inspector"></div>
    </div>
    <div id="debugView">
        <div>(de)bug view: </div>
    </div>
    
    <div id="plyViewWrapper">
        <div>Loaded playlist:</div>
        <div id="plyView"></div>
    </div>
 </body>
 
    <script>
        $('#play_btn').click(function(){
            $.get('/test')
        });
        
        $('#stop_btn').click(function(){
            //$.get('?act="stop"')
            var urlParams = new URLSearchParams(window.location.search);
            urlParams.set('act', 'stop');
            window.location.search = urlParams;
        });
        
        $('#ldply_btn').click(function(){
            var urlParams = new URLSearchParams(window.location.search);
            urlParams.set('act', 'loadPly');
            window.location.search = urlParams;
        });
        
        var templitem1;
        //var templitem2;
        
        $('#mvItemUp').click(function(){
            templitem1 = uiLdPly.PlaylistItems[selectedPlyitem - 1];
            uiLdPly.PlaylistItems[selectedPlyitem - 1] = uiLdPly.PlaylistItems[selectedPlyitem];
            uiLdPly.PlaylistItems[selectedPlyitem] = templitem1;
            uiLdPly.PlaylistItems[selectedPlyitem].id -= -1; // += 1 would add it as string in ALL circumstances :/. JS I guess...
            uiLdPly.PlaylistItems[selectedPlyitem - 1].id -= 1;
            selectedPlyitem -= 1;
            UpdateInspector();
            
            DrawPlyInUI();
        });
        
        $('#mvItemDown').click(function(){
            templitem1 = uiLdPly.PlaylistItems[selectedPlyitem - -1];
            uiLdPly.PlaylistItems[selectedPlyitem - -1] = uiLdPly.PlaylistItems[selectedPlyitem];
            uiLdPly.PlaylistItems[selectedPlyitem] = templitem1;
            uiLdPly.PlaylistItems[selectedPlyitem].id -= 1;
            uiLdPly.PlaylistItems[selectedPlyitem - -1].id -= -1;
            selectedPlyitem -= -1;
            UpdateInspector();
            DrawPlyInUI();
            //DrawDebug();
        });
        
        $('#syncPly').click(function(){
            UploadPlaylist();
        });
        
        $('#drawDebugInfo').click(function(){
            DrawDebug();
        });
        
        $('#tgglEdit').click(function(){
            ToggleInspector();
        });
        
        var selectedPlyitem = -1;
        
        
        
        var uiLdPly
        
        GetCurPly();
        
        function GetCurPly() {
            var plyString = httpGet(window.location.protocol + "//" + window.location.hostname + ":" + window.location.port +  "/playlist");
            setTimeout((document.getElementById("debugView").innerHTML += ("<div>" + plyString + "</div>")), 5000);
            uiLdPly = JSON.parse(plyString);
            DrawPlyInUI();
        }
            
        function DrawPlyInUI() {
            var webpageUItoDRAW = "";
            var forLoopRun = -1;
            for (plitem of uiLdPly.PlaylistItems) {
                forLoopRun += 1;
                webpageUItoDRAW += ("<div class=\"plyitem")
                
                if (forLoopRun%2 == 0) {
                    webpageUItoDRAW += " odd"
                }
                
                webpageUItoDRAW += ("\" id=\"" + forLoopRun + "\">" + plitem.id + " &nbsp&nbsp " + plitem.path + " &nbsp&nbsp " + plitem.startTime + " &nbsp&nbsp " + plitem.duration + "</div>"); //current limitation - won't work with ports 80 or 443
            }
            document.getElementById("plyView").innerHTML = webpageUItoDRAW;
            $(".plyitem").click(function(){
                selectedPlyitem = this.id;
                console.log("selected item: " + selectedPlyitem);
                UpdateInspector();
            });
        }
        
        function UploadPlaylist(){
            var plySend = JSON.stringify(uiLdPly);
            httpPost(window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/plysend", plySend);
        }
        
        function DrawDebug(){
            var plyString = JSON.stringify(uiLdPly);
            document.getElementById("debugView").innerHTML += ("<hr><div>" + plyString + "</div>");
        }
        
        var inspectorDisplayed = false;
        function ToggleInspector(){
            if (inspectorDisplayed == false) {
                inspectorDisplayed = true;
                UpdateInspector();
            } else {
                inspectorDisplayed = false;
                document.getElementById("inspector").innerHTML = "";
            }
        }
        
        function UpdateInspector(){
            if (inspectorDisplayed == true){
                var insItStartMode = uiLdPly.PlaylistItems[selectedPlyitem].startMode;
                if (insItStartMode == "fixed") {insItStartMode = "checked";
                } else {
                    insItStartMode = "";
                }
                document.getElementById("inspector").innerHTML = ("editing item " + selectedPlyitem + "<br>" + "<input type=\"checkbox\"  id=\"fixedCheckbox\"" + insItStartMode + ">fixed event <input name=\"insSave\" id=\"insSave\" value=\"Save\" type=\"submit\">");
                $("#insSave").click(function(){
                    
                    if (document.getElementById("fixedCheckbox").checked != true) {
                        insItStartMode = "auto";
                    } else {
                        insItStartMode = "fixed";
                    }
                    uiLdPly.PlaylistItems[selectedPlyitem].startMode = insItStartMode;
                });
            }
        }
        
        
        function httpGet(url) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open( "GET", url, false );
            xmlHttp.send( null );
            return xmlHttp.responseText;
        }
        
        function httpPost(url, data) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("POST", url, true);
            xmlHttp.send(data);
        }
    </script>
 
 </html>
